program matrix_solver_dgesv
implicit none
  INTEGER, PARAMETER :: dp = KIND(1.0D0)
  INTEGER N, NRHS
  INTEGER, ALLOCATABLE :: IPIV(:)
  REAL(KIND=DP), ALLOCATABLE :: A(:,:), B(:), oldA(:,:)
  INTEGER:: i, LDA, LDB, INFO, ierr
  !
  N = 16
  allocate(A(N,N), IPIV(N), B(N), oldA(N,N), stat= ierr)
  A = reshape ((/5.37D-05,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0, &
       & -1.79D-05,1.0D+03,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,-1.79D-05,7.16D-05,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,-1.79D-05,5.37D-05,0.0D+0,0.0D+0,0.0D+0,-1.79D-05, &
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & -1.79D-05,0.0D+0,0.0D+0,0.0D+0,5.37D-05,-1.79D-05,0.0D+0,0.0D+0, &
       & -1.79D-05,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,1.0D+03,-1.79D-05,0.0D+0,&
       & 0.0D+0,-1.79D-05,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0, &
       & 0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,7.16D-05,-1.79D-05,&
       & 0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0, &
       & 0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,5.37D-05,&
       & 0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,0.0D+0,5.37D-05,&
       & -1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,&
       & 7.16D-05,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,&
       & -1.79D-05,7.16D-05,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,0.0D+0,&
       & 0.0D+0,-1.79D-05,5.37D-05,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,& 
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,-1.79D-05,&
       & 0.0D+0,0.0D+0,0.0D+0,3.58D-05,-1.79D-05,0.0D+0,0.0D+0, &
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0, & 
       & -1.79D-05,0.0D+0,0.0D+0,-1.79D-05,5.37D-05,-1.79D-05,0.0D+0, &
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,5.37D-05,-1.79D-05,&
       & 0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,0.0D+0,&
       & 0.0D+0,0.0D+0,-1.79D-05,0.0D+0,0.0D+0,-1.79D-05,3.58D-05/), (/N,N/))
  B = reshape((/ -3.78D-10,1.02D-09,-4.06D-10,-3.98D-11,-3.43D-11,-4.18D-18,&
       & -2.24D-10,1.00D-10,1.18D-10,-5.71D-10,2.55D-10,1.38D-11,-1.27D-11,&
       & 2.88D-10,4.52D-12,-8.84D-11 /), (/16/))
  oldA = A
  ! Regular dense matrix solver
  NRHS = 1
  LDA = N
  LDB = N
  CALL DGESV( N, NRHS, A, LDA, IPIV, B, LDB, INFO )
  ! A and B are changed
  do i =1, N
     print '(ES11.4 )', B(i)
  end do
  print *, matmul(oldA, B)
deallocate(A, IPIV, B, oldA, stat=ierr)
end program matrix_solver_dgesv
